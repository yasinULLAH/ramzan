<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متقی بننے کا رمضان کورس | Ramadan Tracker</title>
    <meta name="description" content="Complete Ramadan self-assessment course and daily tracker.">
    <meta name="author" content="Yasin Ullah, Pakistan">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#15803d">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-blue: #1e3a8a;
            --border-color: #000;
        }

        body {
            font-family: 'Calibri', sans-serif;
            background-color: #f3f4f6;
            color: #000;
            line-height: 1.8;
        }

        /* Print-like Container */
        .paper-sheet {
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            max-width: 1400px;
            margin: 0 auto;
            border: 1px solid #ccc;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid var(--border-color);
            text-align: center;
            padding: 6px;
            font-size: 1.1rem;
            /* Increased from 0.9rem */
            vertical-align: middle;
        }

        /* Specific fix for Ashra Table to avoid overlap */
        .ashra-table {
            table-layout: auto;
        }

        .ashra-table td {
            white-space: normal;
            word-wrap: break-word;
        }

        /* Sticky Column for Questions on Mobile */
        .sticky-col {
            position: sticky;
            right: 0;
            background-color: #fff;
            z-index: 10;
            border-left: 2px solid #000;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        }

        /* Checkbox Styling to look like grid cells */
        .check-cell {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 30px;
        }

        .check-cell input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }

        /* Custom Header Styling */
        .header-title {
            background-color: var(--primary-blue);
            color: white;
            border-radius: 50px;
            padding: 10px 30px;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
        }

        /* Input lines */
        .input-line {
            border: none;
            border-bottom: 1px dotted #000;
            background: transparent;
            width: 60%;
            outline: none;
            font-family: inherit;
        }

        /* Print adjustments */
        @media print {
            .no-print {
                display: none;
            }

            .paper-sheet {
                box-shadow: none;
                margin: 0;
                width: 100%;
                max-width: none;
            }

            body {
                background: white;
            }
        }

        /* Responsive Table */
        .table-container {
            overflow-x: auto;
            width: 100%;
            border: 2px solid #000;
        }

        /* Celebration Modal */
        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-content {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .mt-4.border-2.border-black.p-2.bg-yellow-50.flex.justify-between.items-center.rounded {
            margin-top: 43px;
        }
    </style>
</head>

<body class="p-2 md:p-6 pb-32">

    <!-- Controls Toolbar -->
    <div
        class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 z-50 flex gap-2 no-print justify-center md:justify-end">
        <button onclick="app.backupData()"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2">
            <i class="fas fa-download"></i> بیک اپ (Save)
        </button>
        <button onclick="app.exportToImage()"
            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2">
            <i class="fas fa-image"></i> تصویر بنائیں (Export)
        </button>
        <button onclick="document.getElementById('fileInput').click()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2">
            <i class="fas fa-upload"></i> بحال کریں (Restore)
        </button>
        <button onclick="app.resetData()"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow-lg flex items-center gap-2">
            <i class="fas fa-trash"></i> ری سیٹ (Reset)
        </button>
        <input type="file" id="fileInput" class="hidden" accept=".json" onchange="app.restoreData(this)">
    </div>

    <!-- Main Sheet -->
    <div class="paper-sheet p-2 md:p-4 border-4 border-double border-gray-800 relative">

        <!-- Decorative Border Corner Pattern (CSS simulated) -->
        <div class="absolute top-1 left-1 w-4 h-4 border-t-2 border-l-2 border-black"></div>
        <div class="absolute top-1 right-1 w-4 h-4 border-t-2 border-r-2 border-black"></div>
        <div class="absolute bottom-1 left-1 w-4 h-4 border-b-2 border-l-2 border-black"></div>
        <div class="absolute bottom-1 right-1 w-4 h-4 border-b-2 border-r-2 border-black"></div>

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 border-b-2 border-black pb-4">

            <!-- Left Box: Rules -->
            <div class="border-2 border-black rounded p-2 text-center text-sm font-bold w-full md:w-1/4">
                <p>ہر خانے میں (✓) کا ایک</p>
                <p>اور (x) کا صفر نمبر ہے</p>
                <div class="mt-2 text-xs border-t border-black pt-1">
                    ایمان داری سے پر کیجیے اور دیکھیے کہ رمضان المبارک میں کیا کھویا کیا پایا
                </div>
            </div>

            <!-- Center: Title & Logo -->
            <div class="text-center flex-1">
                <div class="flex justify-center items-center gap-2 mb-1">
                    <i class="fas fa-mosque text-2xl"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">طالب دعا یسین اللہ</span>
                    <i class="fas fa-star-and-crescent text-2xl"></i>
                </div>
                <h1 class="header-title text-2xl md:text-4xl font-extrabold inline-block mb-2">
                    متقی بننے کا رمضان کورس
                </h1>
            </div>

            <!-- Right Box: User Info -->
            <div class="border-2 border-black rounded p-3 w-full md:w-1/4 text-right">
                <div class="mb-2">
                    <label>نام:</label>
                    <input type="text" id="userName" class="input-line" placeholder="آپ کا نام">
                </div>
                <div>
                    <label>ولدیت:</label>
                    <input type="text" id="userParentage" class="input-line" placeholder="والد کا نام">
                </div>
            </div>
        </header>

        <!-- Subheader -->
        <div class="text-center mb-4 bg-gray-100 border border-gray-400 rounded-full py-1">
            <h2 class="text-lg font-bold">خود جائزہ لیجیے کہ اس ماہِ رمضان المبارک میں اللہ پاک کے یہاں آپ کی پوزیشن کیا
                ہے؟</h2>
        </div>

        <!-- Main Table: Daily Routine -->
        <div class="table-container mb-6">
            <table id="mainTable">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="w-64 sticky-col font-bold text-lg">روزمرہ کے معمولات (سوالات)</th>
                        <!-- Days 1 to 30 generated via JS -->
                    </tr>
                </thead>
                <tbody id="dailyRows">
                    <!-- Rows generated via JS -->
                </tbody>
            </table>
        </div>

        <!-- Bottom Sections Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-0 border-2 border-black">

            <!-- Left Section (Ashra Tasks) -->
            <div class="border-l-2 border-black p-0">
                <div class="bg-gray-100 p-2 text-center font-bold border-b border-black text-base">
                    وہ کام جو عشرے میں کم از کم ایک بار ضرور کرنے ہیں:
                </div>
                <table class="w-full ashra-table">
                    <thead>
                        <tr class="bg-gray-50 text-base">
                            <th class="w-1/2">سوال</th>
                            <th>عشرہ 1</th>
                            <th>عشرہ 2</th>
                            <th>عشرہ 3</th>
                        </tr>
                    </thead>
                    <tbody id="ashraRows">
                        <!-- JS generated -->
                    </tbody>
                </table>
            </div>

            <!-- Center Section (Important Tasks) -->
            <div class="border-l-2 border-black p-0 flex flex-col">
                <div class="bg-gray-100 p-2 text-center font-bold border-b border-black text-base">
                    وہ کام جو بہت اہم ہیں ہر ایک (✓) کے پانچ نمبر ہیں
                </div>
                <div class="p-2 flex-grow">
                    <div class="flex items-center justify-between mb-2 border-b border-dotted border-gray-400 pb-1">
                        <span class="text-base">1. میں نے رمضان المبارک میں ایک مرتبہ قرآن پاک مکمل کیا؟</span>
                        <input type="checkbox" id="quran_complete" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-2 border-b border-dotted border-gray-400 pb-1">
                        <span class="text-base">2. میں نے مسائل ، غسل ، وضو ، نماز اور دعائیں سیکھیں؟</span>
                        <input type="checkbox" id="masail_learned" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-2 border-b border-dotted border-gray-400 pb-1">
                        <span class="text-base">3. میں نے زکوٰۃ اور صدقۃ الفطر ادا کیا؟</span>
                        <input type="checkbox" id="zakat_paid" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-2 border-b border-dotted border-gray-400 pb-1">
                        <span class="text-base">4. میں نے اعتکاف (سنت یا نفلی) کیا؟</span>
                        <input type="checkbox" id="itikaf_done" class="w-5 h-5 accent-blue-800">
                    </div>

                    <div class="mt-4">
                        <p class="text-base font-bold mb-2">5. میں نے آخری عشرہ کی طاق راتوں میں سنت کے مطابق عبادت کی:
                        </p>
                        <div class="flex flex-wrap gap-2 justify-center text-sm">
                            <label class="flex flex-col items-center"><input type="checkbox" id="odd_21"
                                    class="w-4 h-4"><span>21 ویں</span></label>
                            <label class="flex flex-col items-center"><input type="checkbox" id="odd_23"
                                    class="w-4 h-4"><span>23 ویں</span></label>
                            <label class="flex flex-col items-center"><input type="checkbox" id="odd_25"
                                    class="w-4 h-4"><span>25 ویں</span></label>
                            <label class="flex flex-col items-center"><input type="checkbox" id="odd_27"
                                    class="w-4 h-4"><span>27 ویں</span></label>
                            <label class="flex flex-col items-center"><input type="checkbox" id="odd_29"
                                    class="w-4 h-4"><span>29 ویں</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Section (Final Summary) -->
            <div class="p-0 flex flex-col">
                <div class="bg-gray-100 p-2 text-center font-bold border-b border-black text-base">
                    رمضان کا خلاصہ
                </div>
                <div class="p-2 flex-grow">
                    <div class="flex items-center justify-between mb-3 border-b border-dotted border-gray-400 pb-2">
                        <span class="text-base">کیا آپ نے مکمل رمضان تراویح پڑھی؟</span>
                        <input type="checkbox" id="full_taraweeh" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-3 border-b border-dotted border-gray-400 pb-2">
                        <span class="text-base">کیا آپ نے مکمل رمضان روزے رکھے؟</span>
                        <input type="checkbox" id="full_fasts" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-3 border-b border-dotted border-gray-400 pb-2">
                        <span class="text-base">کیا آپ نے مکمل رمضان ایک قرآن سنا؟</span>
                        <input type="checkbox" id="full_quran_heard" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-3 border-b border-dotted border-gray-400 pb-2">
                        <span class="text-base">کیا میں نے آنکھ، کان اور زبان کی حفاظت کی؟</span>
                        <input type="checkbox" id="self_control" class="w-5 h-5 accent-blue-800">
                    </div>
                    <div class="flex items-center justify-between mb-3 border-b border-dotted border-gray-400 pb-2">
                        <span class="text-base">کیا میں نے امت مسلمہ کے لیے خصوصی دعا کی؟</span>
                        <input type="checkbox" id="ummah_dua" class="w-5 h-5 accent-blue-800">
                    </div>
                </div>

                <div class="mt-auto text-center p-2 border-t border-black">
                    <div class="text-red-700 font-bold text-lg">بندہ یسین اللہ</div>
                </div>
            </div>

        </div>

        <!-- Score Display (Added Feature) -->
        <div
            class="mt-4 border-2 border-black p-2 bg-yellow-50 flex flex-col md:flex-row justify-between items-center rounded gap-4">
            <span class="font-bold text-lg">کل نمبر (Total Score):</span>

            <div class="text-center">
                <span class="block text-xl md:text-2xl font-bold text-green-700 font-arabic">الحمد لله رب
                    العالمين</span>
                <span class="text-sm font-bold text-gray-600">یا اللہ تیرا شکر ہے (Ya Allah, Thank You)</span>
            </div>

            <div class="flex items-center gap-4">
                <div id="badgeDisplay"
                    class="hidden flex items-center gap-2 px-3 py-1 rounded bg-white border border-gray-300">
                    <i id="badgeIcon" class="text-2xl text-yellow-500 fas fa-medal"></i>
                    <span id="badgeText" class="font-bold text-lg text-gray-800"></span>
                </div>
                <span id="totalScore" class="font-bold text-2xl text-blue-900">0</span>
            </div>
        </div>

    </div>

    <!-- Spacer to prevent buttons from hiding content -->
    <div class="h-64 no-print"></div>

    <!-- Celebration Modal -->
    <div id="celebrationModal"
        class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div
            class="modal-content bg-white border-4 border-green-600 rounded-lg p-8 max-w-lg w-full text-center shadow-2xl relative">
            <button onclick="document.getElementById('celebrationModal').classList.add('hidden')"
                class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-2xl">&times;</button>

            <i class="fas fa-crown text-6xl text-yellow-500 mb-4 block"></i>
            <h2 class="text-4xl font-bold text-green-700 mb-2 font-arabic">ماشاءاللہ!</h2>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">You have achieved >90% Score!</h3>

            <div class="bg-green-50 p-4 rounded border border-green-200 mb-6">
                <p class="text-lg font-bold text-green-800 mb-2">الحمد لله (Alhamdulillah)</p>
                <p class="text-base text-gray-700">Please perform 2 Rakat <strong>Salat-ul-Shukr</strong> (Prayer of
                    Gratitude) to thank Allah for enabling you to be productive this Ramadan.</p>
            </div>

            <button onclick="document.getElementById('celebrationModal').classList.add('hidden')"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition hover:scale-105">
                سبحان اللہ & جزاک اللہ
            </button>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        const app = {
            dbName: 'RamadanTrackerDB',
            storeName: 'userProgress',
            db: null,
            data: {},

            // Constants matching the image text
            dailyQuestions: [
                "میں نے تہجد کی نماز ادا کی؟",
                "میں نے روزہ رکھا؟",
                "میں نے فجر کی نماز باجماعت ادا کی؟",
                "میں نے فجر کے وقت سورہ یٰسین کی تلاوت کی؟",
                "میں نے سارا دن لڑائی جھگڑا اور جھوٹ سے اجتناب کیا؟",
                "میں نے ظہر کی نماز باجماعت ادا کی؟",
                "عصر کے بعد میں نے نبی کریم ﷺ پر 100 مرتبہ درود بھیجا؟",
                "میں نے کم از کم ایک پارے کی تلاوت کی؟",
                "میں نے عصر کی نماز باجماعت ادا کی؟",
                "میں نے دن میں سو مرتبہ استغفار کیا؟",
                "میں نے مغرب کی نماز باجماعت ادا کی؟",
                "میں نے عشاء کی نماز باجماعت ادا کی اور تراویح بھی پڑھی؟",
                "والدین کی خدمت کی؟"
            ],

            ashraQuestions: [
                "کسی مسلمان بھائی کو اپنے ساتھ افطار کرایا؟",
                "میں نے اللہ کے راستہ میں صدقہ کیا؟",
                "جمعہ کے دن سورہ کہف کی تلاوت کی؟",
                "میں نے 'صلوٰۃ التسبیح' ادا کی؟",
                "ایصال ثواب کیا اور اپنی موت کو یاد کیا؟"
            ],

            modalShown: false,

            init: async function () {
                await this.initDB();
                this.renderTable();
                this.renderAshraTable();
                await this.loadData();
                this.attachListeners();
            },

            initDB: function () {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains(this.storeName)) {
                            this.db.createObjectStore(this.storeName, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onerror = (event) => reject('DB Error: ' + event.target.errorCode);
                });
            },

            renderTable: function () {
                const theadRow = document.querySelector('#mainTable thead tr');
                // Generate Day headers 1 to 30
                for (let i = 1; i <= 30; i++) {
                    const th = document.createElement('th');
                    th.innerText = i;
                    th.className = "w-10 text-center bg-white";
                    theadRow.appendChild(th);
                }

                const tbody = document.getElementById('dailyRows');
                this.dailyQuestions.forEach((q, index) => {
                    const tr = document.createElement('tr');
                    // Question Column
                    const tdQ = document.createElement('td');
                    tdQ.className = "sticky-col font-medium text-right pr-2 bg-white";
                    tdQ.innerText = (index + 1) + ". " + q;
                    tr.appendChild(tdQ);

                    // Day Checkboxes
                    for (let d = 1; d <= 30; d++) {
                        const td = document.createElement('td');
                        const div = document.createElement('div');
                        div.className = 'check-cell';
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.dataset.type = 'daily';
                        input.dataset.row = index;
                        input.dataset.day = d;
                        input.id = `d_${index}_${d}`;
                        div.appendChild(input);
                        td.appendChild(div);
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                });
            },

            renderAshraTable: function () {
                const tbody = document.getElementById('ashraRows');
                this.ashraQuestions.forEach((q, index) => {
                    const tr = document.createElement('tr');
                    const tdQ = document.createElement('td');
                    tdQ.className = "text-right pr-2 text-base";
                    tdQ.innerText = (index + 1) + ". " + q;
                    tr.appendChild(tdQ);

                    for (let a = 1; a <= 3; a++) {
                        const td = document.createElement('td');
                        const div = document.createElement('div');
                        div.className = 'check-cell justify-center';
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.dataset.type = 'ashra';
                        input.dataset.row = index;
                        input.dataset.ashra = a;
                        input.id = `a_${index}_${a}`;
                        div.appendChild(input);
                        td.appendChild(div);
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                });
            },

            saveToDB: function () {
                // Collect all data
                const inputs = document.querySelectorAll('input');
                const state = { id: 'current_state', timestamp: Date.now() };

                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        state[input.id] = input.checked;
                    } else if (input.type === 'text' || input.type === 'file') {
                        if (input.id !== 'fileInput') state[input.id] = input.value;
                    }
                });

                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                store.put(state);

                this.updateScore();
            },

            loadData: async function () {
                return new Promise((resolve) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get('current_state');

                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        if (result) {
                            this.applyDataToUI(result);
                        } else {
                            // First time load: Add 4 sample entries as requested
                            this.populateSampleData();
                        }
                        this.updateScore();
                        resolve();
                    };
                });
            },

            populateSampleData: function () {
                console.log("No previous data found. Starting fresh.");
                // No default data population for production

                // Save this initial state (empty)
                this.saveToDB();

                // Sample Ashra data


                // Save this initial state
                this.saveToDB();
            },

            applyDataToUI: function (data) {
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = data[key];
                        else if (el.type === 'text') el.value = data[key];
                    }
                });
            },

            attachListeners: function () {
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    if (input.id !== 'fileInput') {
                        input.addEventListener('change', () => this.saveToDB());
                        input.addEventListener('input', () => this.saveToDB()); // For text fields
                    }
                });
            },

            exportToImage: function () {
                const element = document.querySelector('.paper-sheet');

                // Hide controls temporarily (redundant with .no-print but safer for capture)
                const originalShadow = element.style.boxShadow;
                element.style.boxShadow = 'none';

                html2canvas(element, {
                    scale: 2, // High resolution
                    useCORS: true,
                    backgroundColor: "#ffffff"
                }).then(canvas => {
                    // Restore styles
                    element.style.boxShadow = originalShadow;

                    const link = document.createElement('a');
                    link.download = `Ramadan_Tracker_${new Date().toISOString().slice(0, 10)}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                });
            },

            getBadge: function (score) {
                if (score >= 401) return { text: "متقی (Pious)", color: "text-green-600", icon: "fa-crown" };
                if (score >= 251) return { text: "عابد (Devout)", color: "text-blue-600", icon: "fa-star" };
                if (score >= 101) return { text: "طالب (Seeker)", color: "text-yellow-600", icon: "fa-book-open" };
                return { text: "آغاز (Beginning)", color: "text-gray-600", icon: "fa-seedling" };
            },

            updateScore: function () {
                let score = 0;
                // Daily: 1 point each
                document.querySelectorAll('input[data-type="daily"]:checked').forEach(() => score += 1);
                // Ashra: 1 point each (assumed based on pattern)
                document.querySelectorAll('input[data-type="ashra"]:checked').forEach(() => score += 1);
                // Important Tasks: 5 points each
                const highValueIds = ['quran_complete', 'masail_learned', 'zakat_paid', 'itikaf_done', 'odd_21', 'odd_23', 'odd_25', 'odd_27', 'odd_29', 'full_taraweeh', 'full_fasts', 'full_quran_heard', 'self_control', 'ummah_dua'];
                highValueIds.forEach(id => {
                    if (document.getElementById(id)?.checked) score += 5;
                });

                document.getElementById('totalScore').innerText = score + " / 475";

                // Update Badge
                const badge = this.getBadge(score);
                const badgeDisplay = document.getElementById('badgeDisplay');
                const badgeText = document.getElementById('badgeText');
                const badgeIcon = document.getElementById('badgeIcon');

                if (score > 0) {
                    badgeDisplay.classList.remove('hidden');
                    badgeText.innerText = badge.text;
                    badgeIcon.className = `text-2xl fas ${badge.icon} ${badge.color}`;
                } else {
                    badgeDisplay.classList.add('hidden');
                }

                // Check for 90% Threshold (Total Max: 475)
                // 90% of 475 = 427.5 => 428
                if (score >= 428 && !this.modalShown) {
                    this.showCelebration();
                    this.modalShown = true;
                }
            },

            showCelebration: function () {
                const modal = document.getElementById('celebrationModal');
                modal.classList.remove('hidden');
                this.triggerConfetti();
            },

            triggerConfetti: function () {
                var duration = 5 * 1000;
                var animationEnd = Date.now() + duration;
                var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 60 };

                function randomInRange(min, max) {
                    return Math.random() * (max - min) + min;
                }

                var interval = setInterval(function () {
                    var timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    var particleCount = 50 * (timeLeft / duration);
                    // since particles fall down, start a bit higher than random
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                    confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
                }, 250);
            },

            backupData: function () {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get('current_state');

                request.onsuccess = (e) => {
                    const data = e.target.result;
                    const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Ramadan_Tracker_Backup_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            },

            restoreData: function (inputElement) {
                const file = inputElement.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data && data.id === 'current_state') {
                            this.applyDataToUI(data);
                            this.saveToDB(); // persist to DB
                            alert('ڈیٹا کامیابی سے بحال ہو گیا (Data Restored Successfully)');
                        } else {
                            alert('غلط فائل فارمیٹ (Invalid File)');
                        }
                    } catch (err) {
                        alert('فائل پڑھنے میں غلطی (Error reading file)');
                    }
                };
                reader.readAsText(file);
            },

            resetData: function () {
                if (confirm("کیا آپ واقعی تمام ریکارڈ حذف کرنا چاہتے ہیں؟ (Are you sure you want to reset?)")) {
                    const inputs = document.querySelectorAll('input');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') input.checked = false;
                        if (input.type === 'text') input.value = '';
                    });
                    this.saveToDB();
                }
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>